<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/Display/Video.js | @m31271n/black-box</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Toolbox for Black Engine."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="@m31271n/black-box"><meta property="twitter:description" content="Toolbox for Black Engine."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/m31271n/black-box"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/AssetManager.js~AssetManager.html">AssetManager</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Scene.js~Scene.html">Scene</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/SceneManager.js~SceneManager.html">SceneManager</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#animation">Animation</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Animation/Breath.js~Breath.html">Breath</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Animation/Ease.js~Ease.html">Ease</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Animation/Fade.js~Fade.html">Fade</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Animation/Tween.js~Tween.html">Tween</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#debug">Debug</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Debug/Console.js~Console.html">Console</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#display">Display</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Display/Bounds.js~Bounds.html">Bounds</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Display/Video.js~Video.html">Video</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#input">Input</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input/DomInteraction.js~DomInteraction.html">DomInteraction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input/MinimalInteractiveArea.js~MinimalInteractiveArea.html">MinimalInteractiveArea</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input/NativeInteraction.js~NativeInteraction.html">NativeInteraction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input/ScaleButton.js~ScaleButton.html">ScaleButton</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/Input/SoundButton.js~SoundButton.html">SoundButton</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#helper">helper</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-transformDOM">transformDOM</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/Display/Video.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { Black, GameObject } from &apos;black-engine&apos;
import Layer from &apos;../Layer&apos;
import { transformDOM } from &apos;../helper/dom&apos;

/**
 * Video player based on HTML5 `&lt;video&gt;` tag.
 *
 * @example
 * const url = &apos;https://url/to/video&apos;
 * const video = new Video(url, {
 *   width: 750,
 *   height: 1500,
 * })
 *
 * class Theater extends Scene {
 *   onAdded() {
 *     this.addChild(video)
 *   }
 * }
 */
class Video extends GameObject {
  /**
   * @param {string} src=&apos;&apos; url of video
   * @param {Object} options
   * @param {string} [options.id=&apos;&apos;] id of video
   * @param {number} [options.width=640] width of video
   * @param {number} [options.height=320] height of video
   * @param {boolean} [options.loop=false] enable loop
   * @param {boolean} [options.hide=false] hide video after creating it
   */
  constructor(
    src,
    { id = &apos;&apos;, width = 640, height = 320, loop = false, hide = false } = {}
  ) {
    super()

    /**
     * @ignore
     */
    this.mSrc = src
    /**
     * @ignore
     */
    this.mId = id
    /**
     * @ignore
     */
    this.mWidth = width
    /**
     * @ignore
     */
    this.mHeight = height
    /**
     * @ignore
     */
    this.mLoop = loop
    /**
     * @ignore
     */
    this.mHide = hide

    /**
     * @ignore
     */
    this.mVideo = this.createVideoDOM()
    /**
     * @ignore
     */
    this.mContainer = null
    /**
     * @ignore
     */
    this.mPreplayPromise = null
    /**
     * @ignore
     */
    this.mReady = false
    /**
     * @ignore
     */
    this.mReadyTime = 0
  }

  /**
   * Create video DOM.
   * @access private
   */
  createVideoDOM() {
    const video = document.createElement(&apos;video&apos;)
    video.src = this.mSrc

    // identifiers
    video.className = &apos;black-video&apos;
    if (this.mId) video.id = this.mId

    // standard adaptation
    video.style.position = &apos;absolute&apos;
    video.style.top = &apos;0&apos;
    video.style.left = &apos;0&apos;
    video.style.zIndex = this.mHide
      ? Layer.DOM_DISPLAY_HIDDEN
      : Layer.DOM_DISPLAY
    if (this.mWidth) video.style.width = `${this.mWidth}px`
    if (this.mHeight) video.style.height = `${this.mHeight}px`

    video.loop = this.mLoop
    video.crossorigin = &apos;anonymous&apos;
    video.setAttribute(&apos;preload&apos;, &apos;auto&apos;)
    video.setAttribute(&apos;playsinline&apos;, &apos;&apos;)

    // WebKit-based browser adaptation
    video.setAttribute(&apos;webkit-playsinline&apos;, &apos;&apos;)

    // QQ Browser
    video.setAttribute(&apos;x5-playsinline&apos;, &apos;&apos;)
    // video.setAttribute(&apos;x5-video-player-type&apos;, &apos;h5&apos;)

    return video
  }

  /**
   * @ignore
   */
  onAdded() {
    const { containerElement } = Black.instance
    this.mContainer = containerElement

    const { mVideo: video } = this
    this.transformVideo()

    video.addEventListener(&apos;ended&apos;, this.onEnd)

    /**
     * @ignore
     */
    this.resizeListener = Black.instance.stage.on(
      &apos;resize&apos;,
      this.transformVideo,
      this
    )

    this.mContainer.appendChild(video)
  }

  /**
   * @ignore
   * @emits {end}
   */
  onEnd = () =&gt; {
    this.post(&apos;end&apos;)
  }

  /**
   * Resize and position current video DOM according stage&apos;s setting.
   * @access private
   */
  transformVideo() {
    const { localTransformation: matrix } = Black.instance.stage
    transformDOM(this.mVideo, matrix)
  }

  /**
   * @ignore
   *
   * @emits {progress}
   */
  onUpdate() {
    const { currentTime } = this.mVideo
    this.post(&apos;progress&apos;, { currentTime })
  }

  /**
   * @ignore
   */
  onRemoved() {
    const { mVideo: video } = this
    if (!video) return

    video.removeEventListener(&apos;ended&apos;, this.onEnd)
    this.resizeListener.off()

    this.mContainer.removeChild(video)
  }

  /**
   * Unlock current video.
   *
   * @see https://stackoverflow.com/a/50480115/1793548
   */
  unlock() {
    const { mVideo: video } = this
    const { paused: isPausedBeforeUnlock } = video
    video.play()
    if (isPausedBeforeUnlock) {
      video.pause()
    }
  }

  /**
   * Play current video.
   *
   * This method will preplay video beforehand. There are following reasons to
   * do this:
   * 1. solve the blinking problem when playing video on Android devices.
   * 2. fetch metadata of video in advance, such as `duration`.
   *
   * @emits {play}
   * @return {Promise} same as DOM API - `play()`
   */
  play() {
    const { mVideo: video } = this

    if (this.mReady) {
      this.post(&apos;play&apos;)
      return video.play()
    }

    this.mPreplayPromise =
      this.mPreplayPromise ||
      new Promise(resolve =&gt; {
        const listener = () =&gt; {
          const { currentTime } = video
          if (currentTime &gt; 0) {
            video.removeEventListener(&apos;timeupdate&apos;, listener)
            this.mReady = true
            this.mReadyTime = currentTime
            video.muted = false
            this.post(&apos;play&apos;)
            resolve()
          }
        }
        video.addEventListener(&apos;timeupdate&apos;, listener)
        video.muted = true
        video.play()
      })
    return this.mPreplayPromise
  }

  /**
   * Pause current video.
   *
   * @emits {pause}
   * @return {Promise} same as DOM API - `pause()`
   */
  pause() {
    this.post(&apos;pause&apos;)
    return this.mVideo.pause()
  }

  /**
   * Reset current video&apos;s timeline.
   *
   * @emits {reset}
   */
  reset() {
    this.post(&apos;reset&apos;)
    this.mVideo.currentTime = this.mReadyTime
  }

  /**
   * Show current video.
   *
   * @emits {show}
   */
  show() {
    this.mVideo.style.zIndex = Layer.DOM_DISPLAY
    this.post(&apos;show&apos;)
  }

  /**
   * Hide current video.
   *
   * @emits {hide}
   */
  hide() {
    this.mVideo.style.zIndex = Layer.DOM_DISPLAY_HIDDEN
    this.post(&apos;hide&apos;)
  }

  /**
   * Get duration of current video.
   */
  get duration() {
    return this.mVideo.duration
  }
}

export default Video
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
